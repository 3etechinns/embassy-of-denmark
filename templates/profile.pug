extends ./layout.pug

block main
  .main-content.profile
    .display-4.text-center.my-4 My Profile
    table.table
      thead
        tr
          th(scope='col') NO.
          th(scope='col') FORM
          th(scope='col') CREATED AT
          th(scope='col') LAST UPDATED
          th(scope='col') PROCESSING STATUS
          th(scope='col') PAYMENT STATUS
          th(scope='col') PRICE(â‚µ)
          th(scope='col') 
          th(scope='col') 
          th(scope='col') 
      tbody
        each formRecord, index in formRecords
          tr
            th(scope='row') #{index + 1}
            td #{formRecord.formType}
            td #{formRecord.createdAt}
            td #{formRecord.updatedAt}
            td
              img.icon.processing-status-icon(src="/img/circle.svg")
              | #{formRecord.status}
            td
              if formRecord.paymentId
                img.icon.payment-status(src="/img/check.svg")
                | Paid 
              else
                img.icon.payment-status(src="/img/x.svg")
                | Unpaid
            td #{200}
            td.edit 
              a(href=`/edit/${formRecord.formId}?type=${formRecord.formType}`)
                img.edit-icon.icon(src="/img/edit.svg" title="edit") 
            td.view 
              a(href=`/view/${formRecord.formId}?type=${formRecord.formType}`)
                img.view-icon.icon(src="/img/eye.svg" title="view")
            if !formRecord.paymentId
              td.customButton.pay-button(title="Pay" id=`${formRecord._id}`)
                img.icon(src="/img/credit-card.svg")
                | Pay
            else 
              td
    if errorMessage
      .alert.alert-warning.text-center(role="alert") #{errorMessage}
  script(src="https://checkout.stripe.com/checkout.js")
  script(src="/js/axios.min.js")

block scripts
  script.
    // stripe checkout
    var handler = StripeCheckout.configure({
      key: "pk_test_AZLJ6GOzlzvtcrxBWn8WAqLh",
      image: "/img/logo.png",
      locale: "auto",
      allowRememberMe: false,
      token: function(token) {
        console.log(document.formRecordId)
        axios
          .post("/forms/payment", { token, formRecordId: document.formRecordId })
          .then(function(res) {
            document.body.innerHTML = "";
            document.body.innerHTML = res.data
            console.log(res);
          })
          .catch(function(err) {
            document.body.innerHTML = "";
            document.body.innerHTML = err.response.data;
            console.log(err.response);
          });
      }
    });

    $(".customButton").click(function(e) {
      // Open Checkout with further options:
      document.formRecordId = this.id;
      console.log(document.formRecordId)
      handler.open({
        name: "Embassy of Denmark",
        description: "Pay for Passport form",
        amount: 2000
      });
      e.preventDefault();
    });

    // Close Checkout on page navigation:
    window.addEventListener("popstate", function() {
      handler.close();
    });

